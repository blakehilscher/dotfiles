#!/usr/bin/env ruby
# encoding: UTF-8

require 'active_support/all'
require 'rest_client'
require 'pry'


class PushBullet
  
  API_HOST = 'https://api.pushbullet.com/api'
  
  attr_accessor :options
  
  def initialize(*args)
    self.options = args.extract_options!
  end
  
  def push(id, title, body=nil)
    # body default
    body = title if body.nil?
    # send the request
    resources.pushes.post( { device_iden: id, title: title, body: body, type: 'note' } )
  end
  
  def devices
    @devices ||= JSON.parse(resources.devices.get)['devices'].collect{|d| OpenStruct.new(d) }
  end
  
  def resources
    OpenStruct.new({
      devices:  resource('devices'),
      pushes:   resource('pushes'),
    })
  end
  
  def resource(name)
    RestClient::Resource.new( File.join(API_HOST, name), options.slice(:user, :password) )
  end
  
end

pb = PushBullet.new( user: ENV['PUSHBULLET_API_KEY'], password: ENV['PUSHBULLET_API_SECRET'] )

title, message = ARGV[0], ARGV[1]

if title.present?
  pb.push(ENV['PUSHBULLET_DEVICE_ID'], title, message)
else
  puts pb.devices
end